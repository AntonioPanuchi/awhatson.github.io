–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ Solobot
1. –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
–ú–æ–¥—É–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ Solobot –ø–æ–∑–≤–æ–ª—è—é—Ç —Ä–∞—Å—à–∏—Ä—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è.

2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É ‚Äú–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É‚Äù.



–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞–∑–¥–µ–ª ¬´–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏¬ª.



3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–∑–¥–µ–ª–∞ ¬´–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏¬ª
–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∂–µ—Ç:

–£–∫–∞–∑—ã–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è.
–ó–∞–¥–∞–≤–∞—Ç—å –Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏.
–ó–∞–≥—Ä—É–∂–∞—Ç—å –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å.
–û–±–Ω–æ–≤–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å.
–ü—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è.
4. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥—É–ª—è–º–∏
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è ‚Äî —Ñ–æ—Ä–º–∞—Ç 16:9.
–í—ã–¥–∞—á–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.
5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –º–æ–¥—É–ª—è.
–°–ª–µ–¥–∏—Ç–µ –∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å—é –Ω–æ–º–µ—Ä–∞ –≤–µ—Ä—Å–∏–∏.
–ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–æ–¥—É–ª—å –Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å.
–¢–µ–ø–µ—Ä—å —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é –º–æ–¥—É–ª–µ–π –¥–ª—è Solo_bot.
–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –º–æ–¥—É–ª–∏ –¥–ª—è –±–æ—Ç–∞, –≤–∫–ª—é—á–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤, —Ç–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (—Ö—É–∫–∏), –ø—Ä–æ—Ç–æ–∫–æ–ª –≤—Å—Ç–∞–≤–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –±—ã—Å—Ç—Ä—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–ø–ª–∞—Ç—ã, –≤–µ–±—Ö—É–∫–∏ –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏.

–¶–µ–ª–∏ –º–æ–¥—É–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:

–ò–∑–æ–ª—è—Ü–∏—è ‚Äî –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø–∞–ø–∫–µ modules/<module_name>/, —Ç–µ–∫—Å—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è.

–ü–æ–¥–∫–ª—é—á–∞–µ–º–æ—Å—Ç—å ‚Äî –º–æ–¥—É–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –≤ —Ñ–∞–π–ª–µ router.py –æ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é router.

–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å UI ‚Äî —Å –ø–æ–º–æ—â—å—é —Ö—É–∫–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ–Ω—é –±–µ–∑ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —è–¥—Ä–æ.

–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –æ—à–∏–±–∫–∏ –º–æ–¥—É–ª—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –Ω–µ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ–∞–π–ª–æ–≤:

modules/
 my_module/
   __init__.py          # —ç–∫—Å–ø–æ—Ä—Ç router (–∏/–∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø—É–±–ª–∏—á–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
   router.py            # –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥: aiogram Router, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö—É–∫–æ–≤
   texts.py             # –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã –º–æ–¥—É–ª—è
   settings.py          # –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è (–≤ —Ç.—á. —Ñ–ª–∞–≥–∏ –≤–∫–ª/–≤—ã–∫–ª)
   models.py            # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –º–æ–¥–µ–ª–∏ SQLAlchemy –¥–ª—è —Ç–∞–±–ª–∏—Ü –º–æ–¥—É–ª—è
   db.py                # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) DAO-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—è–º–∏ –º–æ–¥—É–ª—è
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: —Ö—Ä–∞–Ω–∏—Ç–µ –≤—Å–µ —Ç–µ–∫—Å—Ç—ã, –∫–Ω–æ–ø–∫–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ texts.py. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–º–µ—â–∞–π—Ç–µ –≤ settings.py. –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

–ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ __init__.py:

__all__ = ("router",)
from .router import router
# –í–ê–ñ–ù–û: —á—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è –ø–æ–ø–∞–ª–∏ –≤ metadata –∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ init_db,
# –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –º–æ–¥–µ–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è
from . import models  # noqa: F401
–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –º–æ–¥—É–ª–µ (models.py). –ï—Å–ª–∏ –º–æ–¥—É–ª—å —Å–æ–∑–¥–∞—ë—Ç –∏–ª–∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –æ–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ —Å–≤–æ–∏ —Ç–∞–±–ª–∏—Ü—ã –ª–æ–∫–∞–ª—å–Ω–æ –≤ modules/<name>/models.py.

–ü—Ä–∏–º–µ—Ä:

from datetime import datetime
from sqlalchemy import BigInteger, Column, DateTime, ForeignKey, String
from database.models import Base

class ChannelBonusClaim(Base):
   __tablename__ = "channel_bonus_claims"

   tg_id = Column(BigInteger, ForeignKey("users.tg_id", ondelete="CASCADE"), primary_key=True)
   claimed_at = Column(DateTime, default=datetime.utcnow)
DAO (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–Ω–µ—Å—Ç–∏ –≤ db.py):

from sqlalchemy import select
from sqlalchemy.dialects.postgresql import insert
from sqlalchemy.ext.asyncio import AsyncSession
from .models import ChannelBonusClaim

async def has_claim(session: AsyncSession, tg_id: int) -> bool:
   res = await session.execute(select(ChannelBonusClaim).where(ChannelBonusClaim.tg_id == tg_id))
   return res.scalar_one_or_none() is not None

async def set_claim(session: AsyncSession, tg_id: int):
   stmt = (
       insert(ChannelBonusClaim)
       .values(tg_id=tg_id)
       .on_conflict_do_nothing(index_elements=[ChannelBonusClaim.tg_id])
   )
   await session.execute(stmt)
   await session.commit()
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü: –±–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç Base.metadata.create_all() –≤ database/init_db.py. –ß—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è –ø–æ–ø–∞–ª–∏ –≤ –æ–±—â–µ–µ metadata, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª modules/<name>/models.py –¥–æ –≤—ã–∑–æ–≤–∞ createall(). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–ª—è—Ç—å —Å—Ç—Ä–æ–∫—É from . import models –≤ modules/<name>/__init__.py, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç modules.<name>.router, –ø—Ä–∏ —ç—Ç–æ–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è __init__.py –∏ –º–æ–¥–µ–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è: –Ω–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –º–æ–¥–µ–ª–∏ –º–æ–¥—É–ª–µ–π –≤ database/models.py, –¥–µ—Ä–∂–∏—Ç–µ —Å—Ö–µ–º—É –º–æ–¥—É–ª—è –ª–æ–∫–∞–ª—å–Ω–æ. –¢–∏–ø—ã –¥–∞—Ç –∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–π—Ç–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (TIMESTAMP WITHOUT TIME ZONE ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ naive UTC). –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä Alembic, –≤ –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞—è—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ create_all().

–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π: –∑–∞–≥—Ä—É–∑—á–∏–∫ –∏—â–µ—Ç –º–æ–¥—É–ª–∏ –≤ –ø–∞–ø–∫–µ modules –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç modules.<name>.router. –ï—Å–ª–∏ –º–æ–¥—É–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é router —Ç–∏–ø–∞ aiogram.Router, –æ–Ω –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: —Ñ—É–Ω–∫—Ü–∏—è get_webhook_data(), –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è —Å–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–∞–º–∏ path –∏ handler –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤, –∏ —Ñ—É–Ω–∫—Ü–∏—è get_fast_flow_handler(), –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è —Å–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–∞–º–∏ payment_key –∏ handler –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –æ–ø–ª–∞—Ç—ã.

–°–º. —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤ utils/modules_loader.py:

load_modules_from_folder() ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ router

load_module_webhooks() ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–æ–≤ –º–æ–¥—É–ª–µ–π

load_module_fast_flow_handlers() ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –æ–ø–ª–∞—Ç—ã

–•—É–∫–∏ (—Ç–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è) ‚Äî –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥—É–ª—å –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ register_hook(name, func) –∏–∑ hooks.hooks. –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ö—É–∫–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–Ω–∏—è: start_link, start_menu, profile_menu, view_key_menu, pay_menu_buttons, admin_panel, periodic_notifications.

–ü—Ä–∏–º–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö—É–∫–∞ –≤ –º–æ–¥—É–ª–µ:

from aiogram.types import InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from hooks.hooks import register_hook

def _build_button():
   return InlineKeyboardButton(text="–ú–æ—è –∫–Ω–æ–ø–∫–∞", callback_data="my_module|open")

async def profile_menu_hook(**kwargs):
   # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—Å—Ç–∞–≤–∫–∏ –∫–Ω–æ–ø–æ–∫ (—Å–º. –ø—Ä–æ—Ç–æ–∫–æ–ª –Ω–∏–∂–µ)
   return {"after": "balance", "button": _build_button()}

register_hook("profile_menu", profile_menu_hook)
–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏: –ø—Ä–∏–Ω–∏–º–∞—Ç—å **kwargs –∏ –∏–∑–≤–ª–µ–∫–∞—Ç—å –Ω—É–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ –∏–º–µ–Ω–∏, —Ç–∞–∫ –∫–∞–∫ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ö—É–∫–∏ –ø–µ—Ä–µ–¥–∞—é—Ç session, chat_id, admin –∏ —Ç.–¥. –ù–µ –¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –æ –Ω–∞–ª–∏—á–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

–ü—Ä–æ—Ç–æ–∫–æ–ª –≤—Å—Ç–∞–≤–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫: –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∏–∑ —Ö—É–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π insert_hook_buttons(). –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –∫–æ–Ω–µ—Ü, –≤—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π, —É–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é callback_data, —É–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É callback_data. –ú–æ–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π, –≤–∫–ª—é—á–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ ‚Äî –æ–Ω–∏ –±—É–¥—É—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π.

–ü—Ä–∏–º–µ—Ä—ã:

# 1) –£–±—Ä–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–Ω–æ–ø–∫—É TV –∏ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é
return [
 {"remove": f"connect_tv|{key_name}"},
 {"button": InlineKeyboardButton(text="üì∫ Happ TV", callback_data=f"happ_tv|{key_name}")},
]

# 2) –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏ ¬´balance¬ª –≤ –ø—Ä–æ—Ñ–∏–ª–µ
return {"after": "balance", "button": InlineKeyboardButton(text="üèÜ –¢–æ–ø", callback_data="top_referrers")}

# 3) –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
return {"remove_prefix": "legacy_"}
–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –º–æ–¥—É–ª—å –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –Ω–∏—Ö —á–µ—Ä–µ–∑ —Ö—É–∫ periodic_notifications.

from hooks.hooks import register_hook

async def periodic_notify(bot, session, keys, **kwargs):
   # keys ‚Äî —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (–æ–±—ä–µ–∫—Ç—ã –º–æ–¥–µ–ª–µ–π)
   # –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î —á–µ—Ä–µ–∑ session –∏ —Ç.–¥.
   pass

register_hook("periodic_notifications", periodic_notify)
–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –∑–∞–ø—É—Å–∫ –≤ —Ü–∏–∫–ª–µ handlers/notifications/general_notifications.py, –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è bot, session (AsyncSession), keys (—Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –±–µ–∑ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã –∏ —Ç–∞–π–º–∞—É—Ç—ã –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

¬´–ë—ã—Å—Ç—Ä—ã–π —Ñ–ª–æ—É¬ª –æ–ø–ª–∞—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

def get_fast_flow_handler():
   return {
       "payment_key": "my_flow",  # –∫–ª—é—á —Å—Ü–µ–Ω–∞—Ä–∏—è
       "handler": my_flow_handler,  # async def handler(callback_or_message, session, **kwargs)
   }
–í–µ–±—Ö—É–∫–∏ –º–æ–¥—É–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

def get_webhook_data():
   return {
       "path": "/api/my_module",   # –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
       "handler": my_webhook_handler # async def handler(request): ...
   }
–†–∞–±–æ—Ç–∞ —Å FSM –∏ UX: –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ù–∞–∑–∞–¥¬ª –∏–ª–∏ ¬´–û—Ç–º–µ–Ω–∞¬ª –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –û—á–∏—â–∞–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è. –î–ª—è –∫–Ω–æ–ø–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ InlineKeyboardBuilder, –¥–ª—è –≤—ã–≤–æ–¥–∞ ‚Äî —Ö–µ–ª–ø–µ—Ä handlers.utils.edit_or_send_message.

–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª:

@router.callback_query(F.data.startswith("my_flow_cancel|"))
async def my_flow_cancel(callback: CallbackQuery, state: FSMContext, session):
   await state.clear()
   # –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω –∫–∞—Ä—Ç–æ—á–∫–∏
   key_name = callback.data.split("|")[1]
   from handlers.keys.key_view import render_key_info
   import os
   await render_key_info(callback.message, session, key_name, os.path.join("img", "pic_view.jpg"))
–†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –≤—Ä–µ–º–µ–Ω–µ–º: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ AsyncSession —á–µ—Ä–µ–∑ DI-middleware. –î–ª—è –ø–æ–ª—è TIMESTAMP WITHOUT TIME ZONE –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ naive UTC.

from datetime import datetime, timezone

_dt = datetime.fromisoformat(iso_str.replace("Z", "+00:00"))
start_dt = _dt.astimezone(timezone.utc).replace(tzinfo=None)  # naive UTC
–°–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ aiohttp.ClientSession() —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ 10‚Äì15 —Å–µ–∫—É–Ω–¥, –ª–æ–≥–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, –∫–æ–¥–∏—Ä—É–π—Ç–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

–õ–æ–≥–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –ª–æ–≥–≥–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ from logger import logger. –•—É–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å –∑–∞—â–∏—Ç–æ–π, –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è. –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –æ—Ç–ª–∞–≤–ª–∏–≤–∞–π—Ç–µ –æ–∂–∏–¥–∞–µ–º—ã–µ –æ—à–∏–±–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏—è.

–ü—Ä–∏–º–µ—Ä –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è —Å –∫–Ω–æ–ø–∫–æ–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ:

# modules/hello_world/router.py
from aiogram import Router, F
from aiogram.types import CallbackQuery, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from hooks.hooks import register_hook

router = Router()

def _btn():
   return InlineKeyboardButton(text="üëã –ü—Ä–∏–≤–µ—Ç", callback_data="hello|open")

async def profile_menu_hook(**kwargs):
   return {"after": "balance", "button": _btn()}

register_hook("profile_menu", profile_menu_hook)

@router.callback_query(F.data == "hello|open")
async def open_hello(callback: CallbackQuery):
   kb = InlineKeyboardBuilder()
   kb.row(InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="profile"))
   await callback.message.edit_text("–ü—Ä–∏–≤–µ—Ç –∏–∑ –º–æ–¥—É–ª—è!", reply_markup=kb.as_markup())
–ü—Ä–∏–º–µ—Ä –∑–∞–º–µ–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏:

from aiogram.types import InlineKeyboardButton
from hooks.hooks import register_hook

def _happ_btn(key_name: str):
   return InlineKeyboardButton(text="üì∫ –ü–æ–¥–∫–ª—é—á–∏—Ç—å Happ TV", callback_data=f"happ_tv|{key_name}")

async def view_key_menu_hook(key_name: str, **kwargs):
   return [
       {"remove": f"connect_tv|{key_name}"},
       {"button": _happ_btn(key_name)},
   ]

register_hook("view_key_menu", view_key_menu_hook)
–¢–µ–∫—Å—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è: –ø—Ä–∏–º–µ—Ä settings.py:

ENABLE_BUTTON = True
START_AT_ISO = "2025-08-18T00:00:00Z"
MIN_TOPUP_RUB = 100
TOP_N = 5
–ü—Ä–∏–º–µ—Ä texts.py:

BTN_TOP = "üèÜ –¢–æ–ø –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏—Ö"
TITLE = "<b>üèÜ –¢–æ–ø –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏—Ö</b>\n"
ENTRY = "{place}. <code>{masked_id}</code> ‚Äî {count} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤\n"
NO_DATA = "–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ —É—Å–ª–æ–≤–∏—è."
–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

–°–æ–≤–µ—Ç—ã –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –∫–æ–¥–∞: —á–∏—Ç–∞–π—Ç–µ –∏ –ø–∏—à–∏—Ç–µ –≤ –ë–î —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –¥–µ—Ä–∂–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏, –≤—ã–Ω–æ—Å–∏—Ç–µ —Ä–∞—Å—á—ë—Ç—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ DI –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è session.

–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –º–æ–¥—É–ª—è:

–ï—Å—Ç—å router, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ __init__.py.
–í—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ texts.py, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –≤ settings.py.
–•—É–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ register_hook.
FSM –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–∞—Ö –∏ –æ—à–∏–±–∫–∞—Ö.
–ö–Ω–æ–ø–∫–∏ –∏–∑–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª –æ–ø–µ—Ä–∞—Ü–∏–π.
–°–µ—Ç–µ–≤—ã–µ –≤—ã–∑–æ–≤—ã —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫.
–î–∞—Ç—ã –∏ –≤—Ä–µ–º—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã —Å —Ç–∏–ø–∞–º–∏ –ë–î.
